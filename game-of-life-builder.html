<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Game Of Life</title>
  <script src="game-of-life.js"></script>
  <style>
    #life-sample {
      display: inline-block;
      background-color: #066;
      border: 2px solid #ccc;
      width: 10px;
      height: 10px;
    }

    #empty-sample {
      display: inline-block;
      background-color: #fff;
      border: 2px solid #ccc;
      width: 10px;
      height: 10px;
    }

    #btn-full {
      background-color: #066;
      color: #fff;
    }

    #btn-play {
      color: #002ef8;
    }

    canvas:hover {
      cursor: cell;
    }

  </style>
</head>

<body onload="onload()">
  <div>
    <h3>Conway's Game of Life Builder</h3>
    <a href="https://en.wikipedia.org/wiki/Conway%27s_Game_of_Life">Wikipedia Reference</a>
  </div>
  <br>
  <button id="btn-full" onclick="onFull()">Full</button>
  <button id="btn-clear" onclick="onClear()">Clear</button>
  <button id="btn-prev-generation" onclick="onPrevGeneration()">&lt;&lt; Prev Generation</button>
  <button id="btn-next-generation" onclick="onNextGeneration()">Next Generation &gt;&gt;</button>
  <button id="btn-play" onclick="onPlay()">Play From Here</button>

  <br>
  <br>
  <canvas id="canvas"></canvas>
</body>

<script>
  // constants
  const LIFE_CONFIG = {
    lifeDigit: 1,
    deathDigit: 0,
    lifeSymbol: "O",
    deathSymbol: ".",
  };

  const GENERATIONS = [];

  // global var
  let CANVAS;
  let CONFIG;
  let GRID;
  let isMouseDownOnCanvas = false;
  let isErasing = false;
  let mouseDownCell; // {r, c}
  let hasLife = false;
</script>

<script>


  function attachCanvasEventListeners() {

    CANVAS.addEventListener('mousedown', function onMouseDownCanvas(event) {
      isMouseDownOnCanvas = true;
      // toggle life
      let { r, c } = xyposToIndex(event.offsetX, event.offsetY, CONFIG.cellWidth, CONFIG.cellHeight);
      if (r >= 0 && c >= 0 && r < GRID.length && c < GRID[0].length) {
        GRID[r][c] = GRID[r][c] == LIFE_CONFIG.lifeDigit ? LIFE_CONFIG.deathDigit : LIFE_CONFIG.lifeDigit;
        mouseDownCell = { r, c };
      }
      draw();
    });

    CANVAS.addEventListener('mouseup', function onMouseUpCanvas(event) {
      isMouseDownOnCanvas = false;
      mouseDownCell = undefined;
    });

    CANVAS.addEventListener('mousemove', function onMouseMoveCanvas(event) {
      if (isMouseDownOnCanvas) {
        // drag and place life
        let { r, c } = xyposToIndex(event.offsetX, event.offsetY, CONFIG.cellWidth, CONFIG.cellHeight);
        let isWithinGrid = r >= 0 && c >= 0 && r < GRID.length && c < GRID[0].length;
        let isMoveOnMouseDownCell = mouseDownCell && mouseDownCell.r == r && mouseDownCell.c == c;

        if (isWithinGrid && !isMoveOnMouseDownCell) {
          GRID[r][c] = LIFE_CONFIG.lifeDigit;
          draw();
        }
      }
    });
  }

  function setupCanvas() {
    CANVAS = document.getElementById("canvas");
    CANVAS.width = CONFIG.canvasWidth;
    CANVAS.height = CONFIG.canvasHeight;
    CANVAS.style.border = "1px solid #000";
    attachCanvasEventListeners();
  }

  function recordGeneration() {
    if (hasLife) {
      const trimmed = gridTrimBottomRight(GRID, LIFE_CONFIG.lifeDigit);
      const trimmedStr = gridToCompactString(trimmed, LIFE_CONFIG);

      key = "gol-" + GENERATIONS.length;
      GENERATIONS.push(key);
      sessionStorage.setItem(key, trimmedStr);
    }
  }

  function draw() {
    const context = CANVAS.getContext("2d");
    context.clearRect(0, 0, CANVAS.width, CANVAS.height);

    // Workaround to avoid blurry rectangle border
    context.strokeRect1 = function (x, y, w, h) {
      x = parseInt(x) + 0.50;
      y = parseInt(y) + 0.50;
      this.strokeRect(x, y, w, h);
    }
    context.fillRect1 = function (x, y, w, h) {
      x = parseInt(x);
      y = parseInt(y);
      context.fillRect(x, y, w, h);
    }

    context.strokeStyle = CONFIG.cellBorderStyle;
    context.fillStyle = CONFIG.cellFillStyle;

    // draw grid
    hasLife = false;
    const trimmed = gridTrimBottomRight(GRID, LIFE_CONFIG.lifeDigit);
    const trimmedStr = gridToCompactString(trimmed, LIFE_CONFIG);

    for (let r = 0; r < GRID.length; r++) {
      for (let c = 0; c < GRID[0].length; c++) {
        let x = CONFIG.cellWidth * c;
        let y = CONFIG.cellHeight * r;
        if (GRID[r][c] == LIFE_CONFIG.lifeDigit) {
          // life, fill it
          hasLife = true;
          context.fillRect1(x, y, CONFIG.cellWidth, CONFIG.cellHeight);
        }
        context.strokeRect1(x, y, CONFIG.cellWidth, CONFIG.cellHeight);
      }
    }
  }

  function onFull() {
    fillGrid_(GRID, LIFE_CONFIG.lifeDigit);
    draw();
  }

  function onClear() {
    fillGrid_(GRID, LIFE_CONFIG.deathDigit);
    draw();
  }

  function onPlay() {
    let gridTrimmed = gridTrim(GRID, LIFE_CONFIG.lifeDigit);
    if (!gridTrimmed?.length) {
      alert("Can't play without lifes.");
      return;
    }
    let gridTrimmedStr = gridToCompactString(gridTrimmed, LIFE_CONFIG);
    console.log("Grid trimmed: ", gridTrimmed)
    console.log("Grid stringified: ", gridTrimmedStr)
    window.open(`https://y-pan.github.io/tiny-things/game-of-life.html?factor=${CONFIG.factor}&grid=${gridTrimmedStr}`, "_blank")
  }

  function onNextGeneration() {
    if (hasLife) {
      recordGeneration();
      nextGeneration_(GRID, LIFE_CONFIG);
      draw();
    }
  }

  function onPrevGeneration() {
    if (GENERATIONS.length) {
      const prevKey = GENERATIONS.pop();
      const prevGenStr = sessionStorage.getItem(prevKey);
      sessionStorage.removeItem(prevKey);

      const prevGrid = compactStringToGrid(prevGenStr, LIFE_CONFIG);
      // fill GRID
      for (let r = 0; r < prevGrid.length; r++) {
        for (let c = 0; c < prevGrid[0].length; c++) {
          GRID[r][c] = prevGrid[r][c];
        }
      }
      for (let r = prevGrid.length; r < GRID.length; r++) {
        for (let c = prevGrid[0].length; c < GRID[0].length; c++) {
          GRID[r][c] = LIFE_CONFIG.deathDigit;
        }
      }

      draw();
    }
  }

  function onload() {
    console.log("Start...");
    const params = new URLSearchParams(window.location.search);

    let gridFromParam = gridTrim(compactStringToGrid(params.get("grid"), LIFE_CONFIG), LIFE_CONFIG.lifeDigit);
    console.log("gridFromParam", gridFromParam);

    const factor = Number.parseFloat(params.get("factor")) || 1;

    CONFIG = {
      factor: factor,
      canvasWidth: 800 * factor,
      canvasHeight: 800 * factor,
      numRows: maxNumber(40 * factor, 10, gridFromParam?.length + 10),
      numCols: maxNumber(40 * factor, 10, gridFromParam && gridFromParam[0] && gridFromParam[0].length + 10),
      randomLifeThreshold: 0.7,
      cellBorderStyle: "#ccc",
      cellFillStyle: "#066", // LIFE cell fill color
      lifeSpanMilliSeconds: 200,
    }

    CONFIG.cellWidth = Math.floor(CONFIG.canvasWidth / CONFIG.numCols);
    CONFIG.cellHeight = Math.floor(CONFIG.canvasHeight / CONFIG.numRows);

    GRID = gridFromParam ? gridExpand(gridFromParam, CONFIG.numRows, CONFIG.numCols) : zeros(CONFIG.numRows, CONFIG.numCols);
    console.log("CONFIG: ", CONFIG);
    console.log("First Generation: ", gridToCompactString(GRID, LIFE_CONFIG));

    setupCanvas();
    draw();
  }
</script>

</html>
